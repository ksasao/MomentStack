<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Map Viewer</title>
    <link rel="stylesheet" href="https://d19vzq90twjlae.cloudfront.net/leaflet-0.7.3/leaflet.css" />
 
    <!-- reference to Leaflet JavaScript -->
    <script src="https://d19vzq90twjlae.cloudfront.net/leaflet-0.7.3/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #map {
        position: relative;
      }
        .custom .leaflet-popup-tip,
        .custom .leaflet-popup-content-wrapper {
          background: #ffffff;
          color: #503020;
          font-size: 250%;
        }
      input {
        font-size:18px;
      }
      #map-input{
        position: absolute;
        left: 0; top: 0;
        width: 100%; height: 100vh;
        background: rgba(100, 100, 100, .8);
        z-index: 2147483647;
        display: none;
      }
      #currentLocationBtn {
        position: absolute;
        bottom: 24px;
        right: 16px;
        z-index: 1000;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #ffffff;
        border: 2px solid rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        outline: none;
      }
      #currentLocationBtn:hover {
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.25);
        transform: scale(1.05);
      }
      #currentLocationBtn:active {
        transform: scale(0.95);
      }
      #currentLocationBtn.active {
        background: #2196F3;
        border-color: #1976D2;
      }
      #currentLocationBtn svg {
        width: 24px;
        height: 24px;
        fill: #666666;
      }
      #currentLocationBtn.active svg {
        fill: #ffffff;
      }
      </style>
  </head>
  <body>
    <div class="map-main" id="map" style="width: 100%; height: 1000px"></div>
    <button id="currentLocationBtn" title="現在地へ移動">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
      </svg>
    </button>
    <div id="map-input" style="width: 100%; height: 2.2em; line-height: 2em">
      <input type="text" id="comment_input" value="Hello!" style="width:150px;"/>
      <input type="hidden" id="lat_input" />
      <input type="hidden" id="lng_input" />
      <input type="hidden" id="zoom_input" />
      <input type="submit" value="update" onClick="updateUrl()" />
    </div>    
    <script type="text/javascript">
      var map;
      var marker;
      var popupOptions = {
        'maxWidth': '500',
        'className': 'custom'
      };
      var editmode = false;
      var currentLocationBtn = null;
      var locating = false;
      var deviceBaseUrl = null;

      function getUrlParameter(name) {
        var regexp = new RegExp('[?&]' + name + '=([^&#]*)', 'i');
        var output = regexp.exec(window.location.href);
        return output ? decodeURIComponent(output[1]) : null;
      }

      function setForm(lat, lng, zoom, comment) {
        var latField = document.getElementById('lat_input');
        var lngField = document.getElementById('lng_input');
        var zoomField = document.getElementById('zoom_input');
        latField.value = typeof lat === 'number' ? lat.toFixed(6) : lat;
        lngField.value = typeof lng === 'number' ? lng.toFixed(6) : lng;
        zoomField.value = typeof zoom === 'number' ? zoom : zoom;
        document.getElementById('comment_input').value = comment || '';
      }

      function resolveDeviceBaseUrl() {
        if (deviceBaseUrl !== null) {
          return deviceBaseUrl;
        }
        var explicit = getUrlParameter('device');
        if (explicit) {
          deviceBaseUrl = explicit.replace(/\/+$/, '');
        } else {
          deviceBaseUrl = '';
        }
        return deviceBaseUrl;
      }

      function buildApiUrl(path) {
        var base = resolveDeviceBaseUrl();
        if (!base) {
          return path;
        }
        if (path.charAt(0) !== '/') {
          path = '/' + path;
        }
        return base + path;
      }

      function buildDefaultUrl() {
        var base = window.location.pathname || '/';
        var query = '?p=@35.681307,139.767015,17z&t=Tokyo%20Sta.';
        if (editmode) {
          query += '&edit=t';
        }
        var deviceParam = getUrlParameter('device');
        if (deviceParam) {
          query += '&device=' + encodeURIComponent(deviceParam);
        }
        return base + query;
      }

      function parseConfigFromQuery() {
        var p = getUrlParameter('p');
        if (!p) {
          return null;
        }
        var section = p.split('@');
        if (section.length < 2) {
          return null;
        }
        var coords = section[1].split(',');
        if (coords.length < 3) {
          return null;
        }
        var lat = parseFloat(coords[0]);
        var lng = parseFloat(coords[1]);
        var zoom = parseFloat(coords[2].replace('z', ''));
        if (!isFinite(lat) || !isFinite(lng) || !isFinite(zoom)) {
          return null;
        }
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          return null;
        }
        var text = getUrlParameter('t') || '';
        return { lat: lat, lng: lng, zoom: zoom, text: text };
      }

      function loadDefaultConfig() {
        return { lat: 35.681307, lng: 139.767015, zoom: 17, text: 'Tokyo Sta.' };
      }

      function fetchDeviceConfig() {
        if (!window.fetch) {
          return Promise.reject(new Error('fetch unsupported'));
        }
        var apiUrl = buildApiUrl('/api/location');
        if (window.location.protocol === 'https:' && apiUrl.indexOf('http://') === 0) {
          return Promise.reject(new Error('mixed content blocked'));
        }
        return fetch(apiUrl, { cache: 'no-store', mode: 'cors' })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Failed to load config');
            }
            return response.json();
          })
          .then(function(data) {
            var lat = parseFloat(data.lat);
            var lng = parseFloat(data.lng);
            var zoom = parseFloat(data.zoom);
            if (!isFinite(lat) || !isFinite(lng) || !isFinite(zoom)) {
              throw new Error('Invalid coordinates');
            }
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
              throw new Error('Out of range');
            }
            return {
              lat: lat,
              lng: lng,
              zoom: zoom,
              text: data.text || ''
            };
          });
      }

      function loadInitialConfig() {
        var queryConfig = parseConfigFromQuery();
        if (queryConfig) {
          return Promise.resolve(queryConfig);
        }
        return fetchDeviceConfig().catch(function(err) {
          console.warn('Using default config', err);
          return loadDefaultConfig();
        });
      }

      function collectFormValues() {
        return {
          lat: document.getElementById('lat_input').value,
          lng: document.getElementById('lng_input').value,
          zoom: document.getElementById('zoom_input').value,
          comment: document.getElementById('comment_input').value || ''
        };
      }

      function buildShareUrl(lat, lng, zoom, comment) {
        var base = window.location.pathname || '/';
        var query = '?p=@' + lat + ',' + lng + ',' + zoom + 'z&t=' + encodeURIComponent(comment || '');
        if (editmode) {
          query += '&edit=t';
        }
        var deviceParam = getUrlParameter('device');
        if (deviceParam) {
          query += '&device=' + encodeURIComponent(deviceParam);
        }
        return base + query;
      }

      function submitLocationViaForm(payload, returnUrl) {
        var base = resolveDeviceBaseUrl();
        if (!base) {
          alert('device パラメータが不足しています。QRコードからページを開いてください。');
          return false;
        }
        var apiUrl = buildApiUrl('/api/location');
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = apiUrl;
        form.style.display = 'none';

        function appendField(name, value) {
          var input = document.createElement('input');
          input.type = 'hidden';
          input.name = name;
          input.value = value;
          form.appendChild(input);
        }

        appendField('lat', payload.lat);
        appendField('lng', payload.lng);
        appendField('zoom', payload.zoom);
        appendField('text', payload.comment || '');
        if (returnUrl) {
          appendField('return', returnUrl);
        }

        document.body.appendChild(form);
        form.submit();
        return true;
      }

      function updateUrl() {
        var payload = collectFormValues();
        var targetUrl = buildShareUrl(payload.lat, payload.lng, payload.zoom, payload.comment);
        if (editmode) {
          if (!submitLocationViaForm(payload, targetUrl)) {
            window.location.href = targetUrl;
          }
          return;
        }
        window.location.href = targetUrl;
      }

      function handleLocationResult(newLat, newLng) {
        if (!map || !marker) {
          return;
        }
        map.setView([newLat, newLng], map.getZoom());
        marker.setLatLng([newLat, newLng]);
        document.getElementById('lat_input').value = newLat.toFixed(6);
        document.getElementById('lng_input').value = newLng.toFixed(6);
        document.getElementById('zoom_input').value = map.getZoom();
      }

      function setLocatingState(isLocating) {
        locating = isLocating;
        if (currentLocationBtn) {
          currentLocationBtn.classList.toggle('active', isLocating);
          currentLocationBtn.disabled = isLocating;
        }
      }

      function initializeMap(cfg) {
        map = L.map('map', {
          maxZoom: 18,
          minZoom: 6,
          zoomControl: false
        });
        new L.Control.Zoom({ position: 'bottomleft' }).addTo(map);
        map.setView([cfg.lat, cfg.lng], cfg.zoom);

        L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, '
        }).addTo(map);

        marker = L.marker([cfg.lat, cfg.lng], {}).addTo(map);
        marker.bindPopup(cfg.text || '', popupOptions).openPopup();

        map.on('move', function() {
          var pos = map.getCenter();
          var zoomLevel = map.getZoom();
          if (editmode && marker) {
            marker.setLatLng(pos);
          }
          document.getElementById('lat_input').value = pos.lat.toFixed(6);
          document.getElementById('lng_input').value = pos.lng.toFixed(6);
          document.getElementById('zoom_input').value = zoomLevel;
        });
      }

      function initPage() {
        $(window).on('load resize', function() {
          $('.map-main').outerHeight($(window).height());
        });

        currentLocationBtn = document.getElementById('currentLocationBtn');
        editmode = !!getUrlParameter('edit');
        if (editmode) {
          $('#map-input').css('display', 'inline');
          if (currentLocationBtn) {
            currentLocationBtn.style.display = 'flex';
          }
        } else if (currentLocationBtn) {
          currentLocationBtn.style.display = 'none';
        }

        if (currentLocationBtn) {
          currentLocationBtn.addEventListener('click', function() {
            if (!editmode || locating) {
              return;
            }
            if (!navigator.geolocation) {
              alert('このブラウザは現在地の取得に対応していません。');
              return;
            }
            setLocatingState(true);
            navigator.geolocation.getCurrentPosition(function(position) {
              handleLocationResult(position.coords.latitude, position.coords.longitude);
              setLocatingState(false);
            }, function(error) {
              alert('現在地を取得できません: ' + error.message);
              setLocatingState(false);
            }, {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            });
          });
        }

        loadInitialConfig().then(function(cfg) {
          setForm(cfg.lat, cfg.lng, cfg.zoom, cfg.text);
          initializeMap(cfg);
        }).catch(function(err) {
          console.error('Failed to initialize map', err);
          window.location.href = buildDefaultUrl();
        });
      }

      initPage();
    </script>
  </body>
</html>